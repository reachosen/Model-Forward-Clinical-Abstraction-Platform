# V9.1 Migration Plan - End-to-End Analysis

**Status:** Planning Phase
**Version:** 9.1.0
**Date:** 2025-11-27
**Owner:** Development Team

---

## Executive Summary

This document provides a comprehensive plan for migrating the Clinical Insight Factory Planner from V7/V8 to V9.1 Specification. The migration affects ~6700 lines of code across 16 files and requires careful phased implementation to avoid breaking existing functionality.

**Key Changes:**
- Unified archetype-driven planning (eliminating HAC/USNWR split)
- Strict validation with closed-loop cross-checks
- Mandatory evidence typing (L1/L2/L3)
- 5-Group Rule enforcement
- Pediatric-exclusive compliance

---

## Table of Contents

1. [Current Architecture (AS-IS)](#1-current-architecture-as-is)
2. [Target Architecture (TO-BE)](#2-target-architecture-to-be)
3. [File-by-File Impact Analysis](#3-file-by-file-impact-analysis)
4. [Migration Phases](#4-migration-phases)
5. [Data Flow Analysis](#5-data-flow-analysis)
6. [Risk Assessment](#6-risk-assessment)
7. [Testing Strategy](#7-testing-strategy)
8. [Rollback Plan](#8-rollback-plan)

---

## 1. Current Architecture (AS-IS)

### 1.1 Data Flow

```
PlanningInput (Legacy Schema)
    â†“
planHAC() [plannerAgent.ts]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Intent Inference (optional)    â”‚
â”‚  normalizeArchetype()            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
    â”œâ”€â†’ isUSNWRArchetype() â†’ generateUSNWRPlan()
    â”‚       â†“
    â”‚   generateUSNWRPlanWithLLM() or Templates
    â”‚
    â””â”€â†’ isHACArchetype() â†’ generateHACPlan()
            â†“
        generateHACPlanWithLLM() or Templates
    â†“
normalizeHacConfig() [INJECTS DEFAULTS]
    â†“
assessPlan() [qualityAssessment.ts]
    â†“
PlannerPlan (V1/V2 hybrid)
```

### 1.2 Key Problems

1. **Hardcoded Branching:** HAC vs USNWR split in `plannerAgent.ts`
2. **Dangerous Normalization:** `normalizeHacConfig()` auto-fills missing sections
3. **Inconsistent Signal Groups:** HAC uses 8 groups, USNWR uses 5, no enforcement
4. **Weak Validation:** `validatePlan.ts` only checks generic structure
5. **No Evidence Typing:** Signals lack L1/L2/L3 classification
6. **No Dependency Checks:** Signals can reference non-existent tools

### 1.3 File Inventory

| File | LOC | Purpose | V9.1 Impact |
|------|-----|---------|-------------|
| `plannerAgent.ts` | 1301 | Main orchestrator | ğŸ”´ CRITICAL - Full rewrite of branching logic |
| `researchAugmentedPlanner.ts` | 630 | RAG implementation | ğŸ”´ CRITICAL - Update prompts, evidence typing |
| `externalValidator.ts` | 589 | External validation | ğŸŸ¡ HIGH - Add V9.1 checks |
| `qualityAssessment.ts` | 507 | Quality scoring | ğŸŸ¡ HIGH - New dimensions |
| `validatePlan.ts` | 268 | Basic validation | ğŸ”´ CRITICAL - Implement checklist |
| `domainRouter.ts` | 250 | Domain templates | ğŸŸ¡ HIGH - Add Ortho/Endo, fix 5-groups |
| `llmPlanGeneration.ts` | 231 | LLM generation | ğŸ”´ CRITICAL - Remove normalization, strict mode |
| `llmClient.ts` | 153 | LLM API | ğŸŸ¢ LOW - No changes |

---

## 2. Target Architecture (TO-BE)

### 2.1 V9.1 Data Flow

```
PlanningInput (V9.1 Schema)
  concern, domain_hint, intent, target_population, specific_requirements
    â†“
generatePlan() [NEW - Single Entry Point]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Metric-to-Archetype Matrix Lookup             â”‚
â”‚  CLABSI â†’ Preventability_Detective              â”‚
â”‚  I25 â†’ Process_Auditor                          â”‚
â”‚  C35 â†’ Data_Scavenger                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
buildUnifiedPrompt() [Uses V9.1 System Prompt]
    â†“
callLLMForJSON() [Strict Mode - No Auto-fill]
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Strict Parser (NO normalization)               â”‚
â”‚  - Expect 5 signal groups                       â”‚
â”‚  - Expect evidence_type on all signals          â”‚
â”‚  - Expect linked_tool_id                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
runValidationChecklist() [V9.1 Section 6]
    â”œâ”€â†’ schema_completeness (CRITICAL)
    â”œâ”€â†’ domain_structure_5_groups (CRITICAL)
    â”œâ”€â†’ provenance_safety (CRITICAL)
    â”œâ”€â†’ pediatric_compliance (HIGH)
    â””â”€â†’ dependency_integrity (CRITICAL)
    â†“
PlannerPlan (V9.1 Strict)
```

### 2.2 Key Improvements

1. **Single Pipeline:** No HAC/USNWR branching
2. **Deterministic Archetype:** Matrix-based lookup
3. **Strict Validation:** Fail-fast if sections missing
4. **Evidence Typing:** All signals tagged L1/L2/L3
5. **Dependency Checks:** Cross-reference signals â†” tools
6. **5-Group Rule:** Enforced via types and validation

---

## 3. File-by-File Impact Analysis

### 3.1 models/PlannerPlan.ts âœ… COMPLETED

**Status:** âœ… Done (Story 1)

**Changes Made:**
- Added V9.1 types: `EvidenceType`, `ArchetypeType`, `DomainType`
- Signal groups: `HACSignalGroupId`, `OrthoSignalGroupId`, `EndoSignalGroupId`
- New interfaces: `ClinicalTool`, `Surveillance`, `FieldMappings`, `ValidationChecklist`
- Updated `Signal` with `evidence_type` and `linked_tool_id`
- Legacy V2 support maintained

**Next:** None (Story 1 complete)

---

### 3.2 planner/plannerAgent.ts

**Current State:**
- 1301 lines
- Exports: `planHAC()`, `isHACArchetype()`, `PlannerConfig`
- Branches: `isUSNWRArchetype()` â†’ two separate paths

**Required Changes (Story 2):**

1. **Remove Branching Logic:**
   ```typescript
   // DELETE these functions:
   - isUSNWRArchetype()
   - generateUSNWRPlan()
   - generateHACPlan()
   - generateUSNWRPlanWithTemplates()
   - generateHACPlanWithTemplates()
   ```

2. **Create Archetype Matrix:**
   ```typescript
   // NEW:
   interface ArchetypeMapping {
     concern: RegExp | string;
     domain: DomainType;
     archetype: ArchetypeType;
   }

   const ARCHETYPE_MATRIX: ArchetypeMapping[] = [
     { concern: 'CLABSI', domain: 'HAC', archetype: 'Preventability_Detective' },
     { concern: 'CAUTI', domain: 'HAC', archetype: 'Preventability_Detective' },
     { concern: 'I25', domain: 'Orthopedics', archetype: 'Process_Auditor' },
     { concern: /^C\d+/, domain: 'Endocrinology', archetype: 'Data_Scavenger' },
     // ... complete matrix from Spec Section 3.1
   ];

   function lookupArchetype(concern: string, domainHint?: DomainType): ArchetypeType {
     // Match concern against matrix
   }
   ```

3. **Unified Entry Point:**
   ```typescript
   // REPLACE planHAC() with:
   export async function generatePlan(
     input: PlanningInput,
     config: PlannerConfig = {},
     research?: ResearchBundle
   ): Promise<PlannerPlan> {
     // 1. Validate V9.1 input
     validatePlanningInput(input);

     // 2. Lookup archetype
     const archetype = lookupArchetype(input.concern, input.domain_hint);

     // 3. Single generation path (no branching)
     return generatePlanWithArchetype(input, archetype, config, research);
   }
   ```

**Files Affected:**
- `bin/planner.ts` - Update to call `generatePlan()` instead of `planHAC()`
- `cli/plan.ts` - Same
- `commands/researchPlanImplement.ts` - Same

---

### 3.3 planner/llmPlanGeneration.ts

**Current State:**
- Loads prompt via `loadPlannerSystemPrompt()` (uses env var)
- `normalizeHacConfig()` injects defaults (DANGEROUS in V9.1)
- Separate functions: `generateHACPlanWithLLM()`, `generateUSNWRPlanWithLLM()`

**Required Changes (Story 3):**

1. **Update Prompt Loader:**
   ```typescript
   function loadPlannerSystemPrompt(): string {
     const version = process.env.PLANNER_PROMPT_VERSION || 'v9.1';
     const fileName = `plannerPrompt_${version}.md`;
     const promptPath = path.join(__dirname, fileName);

     if (!fs.existsSync(promptPath)) {
       throw new Error(`Planner prompt not found: ${promptPath}`);
     }

     return fs.readFileSync(promptPath, 'utf-8');
   }
   ```

2. **REMOVE normalizeHacConfig():**
   ```typescript
   // DELETE THIS ENTIRE FUNCTION
   // V9.1 requires strict compliance - no auto-filling
   ```

3. **Strict JSON Parser:**
   ```typescript
   function parseStrictV91Plan(response: any, input: PlanningInput): ClinicalConfig {
     // Validate ALL mandatory sections exist
     const required = [
       'config_metadata', 'clinical_tools', 'surveillance',
       'signals', 'timeline', 'criteria', 'questions',
       'prompts', 'fieldMappings', 'domain'
     ];

     for (const field of required) {
       if (!response[field]) {
         throw new Error(`V9.1 CRITICAL: Missing mandatory section '${field}'`);
       }
     }

     // Validate 5-Group Rule
     const groups = response.signals?.signal_groups || [];
     if (groups.length !== 5) {
       throw new Error(`V9.1 CRITICAL: Expected 5 signal groups, got ${groups.length}`);
     }

     // Validate evidence typing
     for (const group of groups) {
       for (const signal of group.signals || []) {
         if (!signal.evidence_type || !['L1', 'L2', 'L3'].includes(signal.evidence_type)) {
           throw new Error(`V9.1 CRITICAL: Signal '${signal.id}' missing valid evidence_type`);
         }
       }
     }

     return response as ClinicalConfig;
   }
   ```

4. **Unified Generation:**
   ```typescript
   // REPLACE both generateHACPlanWithLLM and generateUSNWRPlanWithLLM with:
   export async function generatePlanWithLLM(
     input: PlanningInput,
     archetype: ArchetypeType,
     config: PlannerConfig,
     planId: string
   ): Promise<PlannerPlan> {
     const systemPrompt = loadPlannerSystemPrompt();
     const userPrompt = buildV91UserPrompt(input, archetype);

     const response = await callLLMForJSON(systemPrompt, userPrompt, config);

     // Strict parsing - no normalization
     const clinicalConfig = parseStrictV91Plan(response, input);

     return {
       plan_metadata: { ... },
       rationale: {
         ...response.rationale,
         pediatric_focus_areas: response.rationale.pediatric_focus_areas || [],
         archetype_selection_reason: `Selected ${archetype} based on Metric-to-Archetype Matrix`
       },
       clinical_config: clinicalConfig,
       validation: { ... } // Will be populated by validatePlan()
     };
   }
   ```

---

### 3.4 planner/validatePlan.ts

**Current State:**
- Basic validation: checks if fields exist
- Returns `{ is_valid, errors[], warnings[], schema_valid, business_rules_valid }`

**Required Changes (Story 4):**

1. **Implement V9.1 Checklist:**
   ```typescript
   export function validatePlanV91(plan: PlannerPlan): ValidationResults {
     const checklist: ValidationChecklist = {
       schema_completeness: checkSchemaCompleteness(plan),
       domain_structure_5_groups: check5GroupRule(plan),
       provenance_safety: checkProvenanceSafety(plan),
       pediatric_compliance: checkPediatricCompliance(plan),
       dependency_integrity: checkDependencyIntegrity(plan)
     };

     const errors: ValidationError[] = [];
     const warnings: ValidationWarning[] = [];

     // Collect errors/warnings from checklist
     for (const [check, result] of Object.entries(checklist)) {
       if (result.result === 'NO') {
         if (result.severity === 'CRITICAL') {
           errors.push({
             code: `ERR_${check.toUpperCase()}`,
             message: result.message || `${check} failed`,
             field: check
           });
         } else {
           warnings.push({
             code: `WARN_${check.toUpperCase()}`,
             message: result.message || `${check} needs review`,
             field: check
           });
         }
       }
     }

     return {
       checklist,
       is_valid: errors.length === 0,
       errors,
       warnings
     };
   }
   ```

2. **Dependency Check:**
   ```typescript
   function checkDependencyIntegrity(plan: PlannerPlan): CheckResult {
     const config = plan.clinical_config;
     const toolIds = new Set(config.clinical_tools.map(t => t.tool_id));
     const errors: string[] = [];

     for (const group of config.signals.signal_groups) {
       for (const signal of group.signals) {
         if (signal.linked_tool_id && !toolIds.has(signal.linked_tool_id)) {
           errors.push(`Signal '${signal.id}' references undefined tool '${signal.linked_tool_id}'`);
         }
       }
     }

     return {
       result: errors.length === 0 ? 'YES' : 'NO',
       severity: 'CRITICAL',
       message: errors.length > 0 ? errors.join('; ') : undefined
     };
   }
   ```

3. **Provenance Safety:**
   ```typescript
   function checkProvenanceSafety(plan: PlannerPlan): CheckResult {
     const domain = plan.clinical_config.config_metadata.domain;
     const signals = plan.clinical_config.signals.signal_groups.flatMap(g => g.signals);

     const errors: string[] = [];

     for (const signal of signals) {
       // Rule: If domain is 'Quality' or 'Mortality', source cannot be 'NHSN'
       if ((domain === 'Quality' || signal.name.includes('Mortality')) &&
           signal.provenance.source === 'NHSN') {
         errors.push(`Signal '${signal.id}': NHSN source invalid for Quality/Mortality domain`);
       }
     }

     return {
       result: errors.length === 0 ? 'YES' : 'NO',
       severity: 'CRITICAL',
       message: errors.length > 0 ? errors.join('; ') : undefined
     };
   }
   ```

4. **Pediatric Check:**
   ```typescript
   function checkPediatricCompliance(plan: PlannerPlan): CheckResult {
     const bannedTerms = ['SOFA', 'qSOFA', 'adult', 'geriatric'];
     const config = JSON.stringify(plan.clinical_config).toLowerCase();
     const violations: string[] = [];

     for (const term of bannedTerms) {
       if (config.includes(term.toLowerCase()) && !config.includes('pediatric ' + term.toLowerCase())) {
         violations.push(term);
       }
     }

     return {
       result: violations.length === 0 ? 'YES' : 'NO',
       severity: 'HIGH',
       message: violations.length > 0
         ? `Found adult-only terms: ${violations.join(', ')}`
         : undefined
     };
   }
   ```

---

### 3.5 planner/researchAugmentedPlanner.ts

**Current State:**
- `buildUserPrompt()` hardcodes "8 HAC groups" or "5 USNWR groups"
- No evidence typing instructions

**Required Changes (Story 5):**

1. **Update RAG Prompt:**
   ```typescript
   function buildV91UserPrompt(
     input: PlanningInput,
     research: ResearchBundle,
     archetype: ArchetypeType
   ): string {
     const domain = input.domain_hint;
     const groupTemplate = get5GroupTemplate(domain);

     return `
   Generate a V9.1 compliant plan using this research:

   ARCHETYPE: ${archetype}
   DOMAIN: ${domain}
   TARGET: ${input.target_population} (MUST BE PEDIATRIC)

   REQUIRED SIGNAL GROUPS (exactly 5):
   ${groupTemplate.map(g => `- ${g.group_id}: ${g.description}`).join('\n')}

   EVIDENCE TYPING:
   - L1 (Direct): Lab values, vital signs, explicit documentation
   - L2 (Derived): Clinical calculations, tool outputs
   - L3 (Narrative): Unstructured notes, clinical judgment

   RESEARCH FINDINGS:
   ${formatResearchFindings(research)}

   CRITICAL RULES:
   1. Tag EVERY signal with evidence_type: 'L1' | 'L2' | 'L3'
   2. Link signals to clinical_tools via linked_tool_id
   3. Use ONLY pediatric guidelines (SPS, PALS, NHSN Pediatric)
   4. REJECT adult scoring systems (SOFA, qSOFA, etc.)
   5. Include all mandatory sections: clinical_tools, surveillance, fieldMappings, etc.
   `;
   }
   ```

2. **Pediatric Filter:**
   ```typescript
   function filterPediatricResearch(research: ResearchBundle): ResearchBundle {
     return {
       ...research,
       research_findings: research.research_findings.filter(finding => {
         const text = JSON.stringify(finding).toLowerCase();
         return (
           text.includes('pediatric') ||
           text.includes('child') ||
           text.includes('picu') ||
           text.includes('nicu') ||
           !text.includes('adult')
         );
       })
     };
   }
   ```

---

### 3.6 planner/domainRouter.ts

**Current State:**
- Exports `getHACGroupTemplates()` (8 groups) and `getUSNWRGroupTemplates()` (5 groups)
- Inconsistent group IDs: uses 'core' and 'ruleouts' instead of 'rule_outs'

**Required Changes (Story 2):**

1. **Fix Signal Group IDs:**
   ```typescript
   // CHANGE:
   - 'core' â†’ 'core_criteria' (for Ortho/Endo)
   - 'ruleouts' â†’ 'rule_outs' (underscore)
   ```

2. **Add Domain Templates:**
   ```typescript
   export function get5GroupTemplate(domain: DomainType): SignalGroup[] {
     switch (domain) {
       case 'HAC':
       case 'Safety':
         return [
           { group_id: 'rule_in', display_name: '...', ... },
           { group_id: 'rule_out', ... },
           { group_id: 'delay_drivers', ... },
           { group_id: 'documentation_gaps', ... },
           { group_id: 'bundle_gaps', ... }
         ];

       case 'Orthopedics':
         return [
           { group_id: 'core_criteria', ... },
           { group_id: 'delay_drivers', ... },
           { group_id: 'documentation', ... },
           { group_id: 'rule_outs', ... },
           { group_id: 'overrides', ... }
         ];

       case 'Endocrinology':
         return [
           { group_id: 'core_criteria', ... },
           { group_id: 'lab_evidence', ... },
           { group_id: 'external_evidence', ... },
           { group_id: 'care_gaps', ... },
           { group_id: 'overrides', ... }
         ];
     }
   }
   ```

---

## 4. Migration Phases

### Phase 1: Foundation (Story 1) âœ… COMPLETED
**Status:** âœ… Done
**Duration:** 1 session
**Files:** `models/PlannerPlan.ts`, `models/PlanningInput.ts`

**Deliverables:**
- âœ… V9.1 type definitions
- âœ… Updated interfaces
- âœ… Legacy support maintained

**Validation:**
- âœ… TypeScript compilation (with expected errors in implementation)

---

### Phase 2: Archetype Unification (Story 2)
**Status:** ğŸ”´ Not Started
**Duration:** 2-3 sessions
**Dependencies:** Phase 1

**Files to Modify:**
1. `planner/plannerAgent.ts` - Remove branching, add matrix
2. `planner/domainRouter.ts` - Fix group IDs, add templates
3. `bin/planner.ts` - Update function calls
4. `cli/plan.ts` - Update function calls
5. `commands/researchPlanImplement.ts` - Update function calls

**Deliverables:**
- [ ] `ARCHETYPE_MATRIX` implementation
- [ ] `lookupArchetype()` function
- [ ] `generatePlan()` unified entry point
- [ ] Domain template functions
- [ ] Update all entry points to use new API

**Validation:**
- [ ] Test CLABSI â†’ Preventability_Detective mapping
- [ ] Test I25 â†’ Process_Auditor mapping
- [ ] Ensure no more HAC/USNWR branching

**Rollback:** Revert commit, restore `planHAC()` function

---

### Phase 3: LLM Generation & Prompts (Story 3)
**Status:** ğŸ”´ Not Started
**Duration:** 2-3 sessions
**Dependencies:** Phase 2

**Files to Modify:**
1. `planner/llmPlanGeneration.ts` - Remove normalization, strict parsing
2. `planner/llmClient.ts` - No changes (maybe timeout adjustment)

**Deliverables:**
- [ ] Delete `normalizeHacConfig()`
- [ ] Implement `parseStrictV91Plan()`
- [ ] Update prompt loader to default to v9.1
- [ ] Single `generatePlanWithLLM()` function
- [ ] Comprehensive error messages when validation fails

**Validation:**
- [ ] LLM returns plan with all mandatory sections â†’ PASS
- [ ] LLM returns plan missing `surveillance` â†’ FAIL with clear error
- [ ] LLM returns plan with 4 signal groups â†’ FAIL with clear error
- [ ] All signals have `evidence_type` â†’ PASS

**Rollback:** Restore `normalizeHacConfig()`, revert strict parsing

---

### Phase 4: Validation Checklist (Story 4)
**Status:** ğŸ”´ Not Started
**Duration:** 2-3 sessions
**Dependencies:** Phase 3

**Files to Modify:**
1. `planner/validatePlan.ts` - Implement V9.1 checklist
2. `planner/externalValidator.ts` - Add V9.1-specific checks

**Deliverables:**
- [ ] `validatePlanV91()` function
- [ ] `checkDependencyIntegrity()` - signals â†” tools
- [ ] `checkProvenanceSafety()` - domain/source alignment
- [ ] `checkPediatricCompliance()` - ban adult terms
- [ ] `check5GroupRule()` - enforce exactly 5 groups
- [ ] `checkSchemaCompleteness()` - all sections present

**Validation:**
- [ ] Plan with undefined tool reference â†’ CRITICAL error
- [ ] Plan with NHSN source in Quality domain â†’ CRITICAL error
- [ ] Plan with 'SOFA' without 'pediatric' â†’ HIGH warning
- [ ] Plan with 3 signal groups â†’ CRITICAL error

**Rollback:** Restore old validation logic

---

### Phase 5: Research Module (Story 5)
**Status:** ğŸ”´ Not Started
**Duration:** 2 sessions
**Dependencies:** Phases 2-4

**Files to Modify:**
1. `planner/researchAugmentedPlanner.ts` - Update prompts, evidence typing

**Deliverables:**
- [ ] `buildV91UserPrompt()` with evidence typing instructions
- [ ] `filterPediatricResearch()` function
- [ ] 5-Group Rule injection into RAG prompt
- [ ] L1/L2/L3 evidence type examples in prompt

**Validation:**
- [ ] Research-augmented plan includes evidence typing
- [ ] Only pediatric research sources used
- [ ] Signals linked to research findings

**Rollback:** Restore old prompt generation

---

## 5. Data Flow Analysis

### 5.1 Entry Points

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Entry Points (3 locations)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. bin/planner.ts â†’ rpi command            â”‚
â”‚  2. cli/plan.ts â†’ direct planning           â”‚
â”‚  3. commands/researchPlanImplement.ts       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â†“
    generatePlan()  [V9.1]
    or planHAC()    [Legacy]
```

### 5.2 Core Pipeline

```
generatePlan(input, config, research?)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Input Validation                   â”‚
â”‚    - Check V9.1 required fields       â”‚
â”‚    - Normalize concern ID             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Archetype Lookup                   â”‚
â”‚    - lookupArchetype(concern, domain) â”‚
â”‚    - Returns: ArchetypeType           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Plan Generation                    â”‚
â”‚    â”œâ”€â†’ Research Mode?                 â”‚
â”‚    â”‚   â””â”€â†’ generatePlanWithResearch() â”‚
â”‚    â””â”€â†’ Direct LLM                     â”‚
â”‚        â””â”€â†’ generatePlanWithLLM()      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Strict Parsing                     â”‚
â”‚    - parseStrictV91Plan()             â”‚
â”‚    - NO auto-fill / normalization     â”‚
â”‚    - Fail if sections missing         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Validation Checklist               â”‚
â”‚    - validatePlanV91()                â”‚
â”‚    - Check all 5 dimensions           â”‚
â”‚    - Populate errors/warnings         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
  PlannerPlan (V9.1)
```

---

## 6. Risk Assessment

| Risk | Impact | Probability | Mitigation |
|------|--------|-------------|------------|
| LLM fails to generate 5 groups | ğŸ”´ HIGH | Medium | Detailed prompt examples, fallback templates |
| Breaking change to existing API | ğŸ”´ HIGH | High | Maintain `planHAC()` as wrapper during transition |
| Validation too strict, blocks valid plans | ğŸŸ¡ MED | Medium | Staged rollout, monitor error rates |
| Research mode incompatible | ğŸŸ¡ MED | Low | Update in parallel, test extensively |
| TypeScript compilation errors | ğŸŸ¢ LOW | High | Phase 1 done, remaining are expected |

---

## 7. Testing Strategy

### 7.1 Unit Tests

```typescript
describe('Archetype Matrix', () => {
  it('maps CLABSI to Preventability_Detective', () => {
    expect(lookupArchetype('CLABSI', 'HAC')).toBe('Preventability_Detective');
  });

  it('maps I25 to Process_Auditor', () => {
    expect(lookupArchetype('I25', 'Orthopedics')).toBe('Process_Auditor');
  });
});

describe('Validation Checklist', () => {
  it('fails on missing surveillance section', () => {
    const plan = createPlanWithoutSurveillance();
    const result = validatePlanV91(plan);
    expect(result.is_valid).toBe(false);
    expect(result.errors[0].code).toBe('ERR_SCHEMA_COMPLETENESS');
  });

  it('fails on signal referencing undefined tool', () => {
    const plan = createPlanWithInvalidToolRef();
    const result = validatePlanV91(plan);
    expect(result.errors[0].code).toBe('ERR_DEPENDENCY_INTEGRITY');
  });
});
```

### 7.2 Integration Tests

```typescript
describe('End-to-End Planning', () => {
  it('generates valid CLABSI plan with V9.1', async () => {
    const input: PlanningInput = {
      concern: 'CLABSI',
      domain_hint: 'HAC',
      intent: 'surveillance',
      target_population: 'PICU patients < 18y',
      specific_requirements: ['Align with SPS bundles']
    };

    const plan = await generatePlan(input, { useMock: true });

    expect(plan.validation.checklist.schema_completeness.result).toBe('YES');
    expect(plan.validation.checklist.domain_structure_5_groups.result).toBe('YES');
    expect(plan.clinical_config.signals.signal_groups).toHaveLength(5);
  });
});
```

### 7.3 Regression Tests

- [ ] Existing CLABSI plans still generate
- [ ] USNWR I25 plans still generate
- [ ] Research-augmented mode works
- [ ] Mock mode (templates) works

---

## 8. Rollback Plan

### 8.1 Phase-Level Rollback

Each phase is a separate commit/PR. Rollback by:
```bash
git revert <commit-hash>
```

### 8.2 Feature Flags (Optional)

```typescript
const USE_V91 = process.env.USE_V91_PLANNER === 'true';

export async function planHAC(...) {
  if (USE_V91) {
    return generatePlan(...);
  } else {
    return legacyPlanHAC(...);
  }
}
```

### 8.3 Compatibility Shim

During transition, maintain both APIs:
```typescript
// Legacy API (deprecated)
export async function planHAC(input: PlanningInput, ...): Promise<PlannerPlan> {
  // Convert old input to V9.1 format
  const v91Input: PlanningInput = {
    concern: input.concern_id || '',
    domain_hint: inferDomainHint(input.domain),
    intent: 'surveillance',
    target_population: input.clinical_context?.population || 'All patients',
    specific_requirements: []
  };

  return generatePlan(v91Input, ...);
}

// V9.1 API (new)
export async function generatePlan(input: PlanningInput, ...): Promise<PlannerPlan> {
  // ...
}
```

---

## 9. Success Criteria

### 9.1 Phase Completion

- [ ] All files compile without errors
- [ ] All unit tests pass
- [ ] Integration tests pass
- [ ] No regression in existing plans
- [ ] Documentation updated

### 9.2 V9.1 Compliance

- [ ] All plans have exactly 5 signal groups
- [ ] All signals have `evidence_type`
- [ ] All signals with tools have `linked_tool_id`
- [ ] Validation checklist populated
- [ ] No adult-only scoring systems in pediatric plans
- [ ] Provenance sources align with domains

### 9.3 Performance

- [ ] Plan generation time < 30s (LLM mode)
- [ ] Plan generation time < 1s (template mode)
- [ ] Validation time < 100ms

---

## 10. Timeline Estimate

| Phase | Duration | Dependencies | Risk |
|-------|----------|--------------|------|
| Phase 1: Models âœ… | 1 session | None | ğŸŸ¢ LOW |
| Phase 2: Archetype | 2-3 sessions | Phase 1 | ğŸŸ¡ MED |
| Phase 3: LLM | 2-3 sessions | Phase 2 | ğŸŸ¡ MED |
| Phase 4: Validation | 2-3 sessions | Phase 3 | ğŸŸ¡ MED |
| Phase 5: Research | 2 sessions | 2-4 | ğŸŸ¢ LOW |
| **TOTAL** | **9-13 sessions** | | |

**Assumptions:**
- 1 session = 2-4 hours focused work
- Testing included in each phase
- No major blockers

---

## 11. Next Steps

### Immediate (Today)
1. âœ… Review this migration plan
2. [ ] Approve Phase 2 start
3. [ ] Set `PLANNER_PROMPT_VERSION=v9.1` in `.env` for testing

### Phase 2 (Next Session)
1. [ ] Implement Archetype Matrix in `plannerAgent.ts`
2. [ ] Fix signal group IDs in `domainRouter.ts`
3. [ ] Create `generatePlan()` unified entry point
4. [ ] Update entry points to use new API
5. [ ] Run compilation tests

### Long-term
- [ ] Complete all 5 phases
- [ ] Performance testing with real LLM
- [ ] Deploy to staging
- [ ] Validate against real clinical cases

---

**End of Migration Plan**

